<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>شات شهاب</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* المتغيرات الأساسية للألوان والأحجام */
    :root {
      --primary-dark: #0a3d62;
      --primary-light: #000;
      --accent-color: #25d366;
      --danger-color: #c0392b;
      --wa-sent-bubble-bg: #e1ffc7;
      --wa-recv-bubble-bg: #ffffff;
      --background-color: #fafafa;
      --text-dark: #333;
      --text-light: #ffffff;
      --font-size: 13px;
      --bubble-padding: 5px 10px; 
      --main-bg-gradient: linear-gradient(90deg, var(--primary-light), var(--primary-dark));
      --card-bg-color: #ffffff;
      --border-color: #eee;
      --body-bg: #f5f5f5;
    }
    * { box-sizing: border-box; }
    html { 
      height: 100%; 
    }
    /* إعدادات الجسم الأساسية */
    body {
      height: 100%;
      margin: 0;
      font-family: "Cairo", Arial, sans-serif;
      background-color: var(--body-bg);
      display: block; 
    }
    /* الحاوية الرئيسية للتطبيق */
    .chat-container {
      width: 100%;
      height: 100%;
      height: 100dvh; 
      background: var(--background-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    /* الشريط العلوي (العنوان والأيقونة) */
    .chat-header {
      display: flex; align-items: center; gap: 10px; padding: 8px;
      background: var(--main-bg-gradient); color: var(--text-light); position: relative; z-index: 10;
      flex-shrink: 0;
    }
    .chat-header .avatar {
      width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--text-light); object-fit: cover;
    }
    .chat-header .title { margin: 0; font-size: 18px; font-weight: 800; }
    .logout-btn {
      margin-right: auto; padding: 6px 10px; background: linear-gradient(90deg, #c0392b, #e74c3c);
      color: var(--text-light); border: none; border-radius: 20px; cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25); 
      font-size: var(--font-size); 
      white-space: nowrap;
    }
    /* شريط التنقل (الدردشة، الأعضاء...) */
    .chat-nav {
      display: flex; background: var(--main-bg-gradient); position: relative; z-index: 10;
      flex-shrink: 0;
    }
    .nav-btn {
      flex: 1; padding: 10px 6px; background: transparent; border: none;
      color: var(--text-light); 
      font-size: var(--font-size); 
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .nav-btn.active { background: rgba(255,255,255,0.08); }
    /* حاوية الصفحات المتغيرة */
    .chat-content { 
        flex: 1; display: flex; flex-direction: column; min-height: 0; position: relative; 
    }
    /* إعدادات الصفحة الافتراضية (مخفية) */
    .page {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; flex-direction: column; min-height: 0;
        visibility: hidden; opacity: 0;
        transition: opacity 0.2s ease-in-out, visibility 0.2s;
        pointer-events: none;
    }
    .page.active {
        visibility: visible; opacity: 1; z-index: 5;
        pointer-events: auto;
    }
    /* --- تعديل: إضافة تثبيت للخلفية --- */
    .chat-page {
      background-size: cover; 
      background-position: center; 
      background-repeat: no-repeat;
      background-attachment: fixed; /* تثبيت الخلفية عند التمرير */
      background-color: #f0f2f5;
      transition: background-image 0.3s ease-in-out;
    }
    /* حاوية عرض الرسائل */
    .messages {
      flex: 1; padding: 10px 8px; overflow-y: auto; display: flex; flex-direction: column;
      gap: 1px; background-color: transparent;
    }
    .load-more-container {
        display: flex;
        justify-content: center;
        padding: 8px;
    }
    .load-more-btn {
        background: var(--primary-dark);
        color: var(--text-light);
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
    }
    .load-more-btn:disabled {
        background: #999;
        cursor: not-allowed;
    }
    .welcome-message {
        text-align: center; margin: 20px auto; padding: 10px 15px;
        background-color: rgba(255, 255, 255, 0.8); border-radius: 12px;
        color: var(--text-dark); max-width: 80%;
    }
    /* السطر الخاص بكل رسالة (لتحديد يمين/يسار) */
    .message-row { display: flex; align-items: flex-end; gap: 8px; max-width: 85%; }
    .message-row.sent { align-self: flex-end; flex-direction: row-reverse; }
    .message-row.recv { align-self: flex-start; flex-direction: row; max-width: 75%; }
    /* تعديل: تصغير أيقونة المرسل (الخاصة بي) */
    .chat-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    
    /* فقاعة الرسالة نفسها (الخلفية والهوامش) */
    .bubble {
      padding: var(--bubble-padding); 
      border-radius: 12px; line-height: 1.5; word-wrap: break-word;
      width: fit-content; 
      font-size: var(--font-size); 
      box-shadow: 0 1px 1px rgba(0,0,0,0.1);
      position: relative; color: var(--text-dark);
      text-shadow: 0 1px 1px rgba(0,0,0,0.2);
      transition: padding 0.2s ease-in-out;
    }
    .bubble.sent { background: var(--wa-sent-bubble-bg); border-top-right-radius: 0; }
    .bubble.recv { background: var(--wa-recv-bubble-bg); border: 1px solid var(--border-color); border-top-left-radius: 0; }
    .bubble-content { display: flex; flex-direction: column; }
    /* تعديل: تصغير خط اسم المرسل */
    .bubble-sender {
      font-size: calc(var(--font-size) - 1px); 
      font-weight: bold; color: var(--primary-dark);
      margin-bottom: 2px; display: flex; align-items: center; gap: 4px;
    }
    /* تعديل: تصغير خط وقت الإرسال */
    .timestamp {
        font-size: 10px; color: #667781; text-align: left;
        margin-top: 4px; direction: ltr; text-shadow: none;
    }
    /* الشريط السفلي لإدخال الرسالة */
    .chat-input {
      display: flex; align-items: center; gap: 8px; padding: 6px;
      background: var(--main-bg-gradient); border-top: 1px solid rgba(255,255,255,0.08);
      direction: ltr; position: relative; z-index: 10;
      flex-shrink: 0;
    }
    /* تعديل: تصغير حقل الإدخال */
    .msg-input {
      flex: 1; padding: 8px 12px; border-radius: 22px; border: 1px solid #ccc;
      outline: none; background: var(--text-light); 
      font-size: calc(var(--font-size) + 2px); 
      direction: rtl;
    }
    /* تعديل: تصغير زر الإرسال */
    .send-btn {
      width: 40px; height: 40px; border: none; border-radius: 50%; background: var(--accent-color);
      color: var(--text-light); font-size: 18px; cursor: pointer; display: flex;
      align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }
    /* تعديل: تقليل الهوامش في الصفحات (الأعضاء، الإعدادات...) */
    .page-container { flex: 1; display: flex; flex-direction: column; padding: 12px; gap: 12px; overflow-y: auto; }
    .search-bar {
      display: flex; align-items: center; gap: 8px; background: var(--card-bg-color); padding: 8px 12px;
      border-radius: 24px; border: 1px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.1); direction: rtl;
    }
    .search-bar input {
      flex: 1; border: none; outline: none; background: transparent; 
      font-size: var(--font-size); 
      direction: rtl; color: var(--text-dark);
    }
    /* قائمة الأعضاء */
    .members-list { display: flex; flex-direction: column; gap: 8px; } /* تعديل: تقليل الفجوة */
    /* --- تعديل: تصغير بطاقة العضو --- */
    .member-item-wrapper {
      padding: 2px; background-image: var(--main-bg-gradient); border-radius: 14px; /* تصغير الحواف */
      transition: transform 0.2s;
      display: flex;
    }
    .member-item {
      display: flex; align-items: center; gap: 10px; padding: 8px; /* تصغير الهوامش */
      background: var(--card-bg-color); border-radius: 12px; /* تصغير الحواف */
      position: relative; cursor: pointer;
      flex: 1;
    }
    .member-avatar { 
        width: 40px; height: 40px; /* تصغير الأيقونة */
        border-radius: 50%; object-fit: cover; 
        background-color: #e0e0e0;
        flex-shrink: 0; /* منع التقلص */
    }
    /* --- تعديل: لتهيئة عرض معلومات العضو والحالة --- */
    .member-info { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        justify-content: center;
        min-width: 0; /* منع تجاوز النص */
    }
    .member-name {
        margin: 0; 
        font-size: calc(var(--font-size) + 1px);
        font-weight: 600; color: var(--text-dark);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis; /* قص النص الطويل */
    }
    /* --- إضافة: تنسيق حالة الاتصال --- */
    .status-dot {
        width: 10px; height: 10px; border-radius: 50%;
        background-color: #95a5a6; /* Offline (grey) */
        border: 1px solid var(--card-bg-color);
        margin-left: 8px; 
        flex-shrink: 0; 
        transition: background-color 0.3s ease;
    }
    .status-dot.online {
        background-color: #2ecc71; /* Online (green) */
    }
    .member-status {
        font-size: calc(var(--font-size) - 2px); 
        color: #777; margin-top: 2px;
    }
    body.dark-mode .member-status {
        color: #bdc3c7;
    }
    /* --- نهاية الإضافة --- */




    /* قسم عرض البروفايل (الصورة والاسم) */
    .card-section {
      display: flex; flex-direction: column; gap: 8px; background: var(--card-bg-color); padding: 12px;
      border-radius: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); align-items: center;
    }
    /* تعديل: تصغير صورة البروفايل */
    .profile-avatar, .view-profile-avatar {
      width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--primary-dark); object-fit: cover;
    }
    /* تعديل: تصغير اسم البروفايل */
    .profile-name { font-size: 22px; font-weight: 700; color: var(--primary-dark); margin: 8px 0 0 0; }
    .profile-edit-btn, .form-btn-confirm, .settings-btn-themed {
      padding: 10px 16px; border: none; border-radius: 20px; color: var(--text-light);
      background: var(--main-bg-gradient); cursor: pointer;
    }
    /* صفحة تسجيل الدخول / إكمال البروفايل */
    .auth-page {
      flex: 1; display: flex; flex-direction: column; justify-content: center;
      align-items: center; padding: 20px; background: var(--body-bg); gap: 20px;
      overflow-y: auto;
    }
    /* تعديل: تصغير عنوان الصفحة */
    .auth-title { font-size: 22px; font-weight: bold; color: var(--primary-dark); text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
    /* تعديل: تقليل هوامش بطاقة الدخول */
    .auth-card {
      background: var(--card-bg-color); width: 100%; max-width: 340px; padding: 20px;
      border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; gap: 16px;
    }
    .auth-input-group { display: flex; flex-direction: column; gap: 8px; }
    /* تعديل: تصغير حقول الإدخال */
    .auth-input {
      width: 100%; padding: 10px; border-radius: 12px; border: 1px solid #ccc;
      font-size: var(--font-size); 
      background-color: var(--card-bg-color); color: var(--text-dark);
    }
    .form-btn-cancel { padding: 10px; border: none; border-radius: 20px; color: var(--primary-dark); background: #eee; cursor: pointer; }
    
    .settings-btn-themed, .form-btn-confirm, .form-btn-cancel {
        font-size: var(--font-size);
    }
    
    .form-btn-group { 
        display: flex; gap: 10px; margin-top: 10px; 
        justify-content: center;
    }




    /* تعديل: تصغير أيقونة التسجيل */
    .signup-avatar { 
        width: 70px; height: 70px; border-radius: 50%; 
        object-fit: cover; border: 2px solid var(--primary-dark); 
        cursor: pointer; 
    }
    .avatar-note {
        font-size: 12px; color: #777; margin: 4px 0 0 0; text-align: center;
    }








    .error-message { color: var(--danger-color); font-size: 12px; text-align: center; margin-top: 8px; display: none; }
    #loadingScreen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8);
      display: flex; justify-content: center; align-items: center; z-index: 1000;
    }
    .loading-spinner {
      border: 4px solid rgba(10, 61, 98, 0.2); border-top: 4px solid var(--primary-dark);
      border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }




    /* قسم في صفحة الإعدادات */
    .settings-section, .profile-details-section {
        display: flex; flex-direction: column; gap: 8px; background: var(--card-bg-color);
        padding: 12px; border-radius: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); align-items: stretch;
    }
    /* تعديل: تصغير عنوان القسم */
    .settings-section-title {
        margin: 0 0 8px 0; font-size: 17px; font-weight: 700; color: var(--primary-dark);
        border-bottom: 2px solid var(--border-color); padding-bottom: 4px;
    }
    .settings-option, .profile-detail-item {
        display: flex; flex-wrap: wrap; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border-color);
    }
    .settings-option:last-child, .profile-detail-item:last-child { border-bottom: none; }
    /* تعديل: تصغير خط النصوص */
    .label { 
        flex: 1; 
        font-size: var(--font-size); 
        color: var(--text-dark); 
    }
    .value { 
        font-size: var(--font-size); 
        color: var(--primary-dark); font-weight: 600; 
    }
    .settings-input-color { width: 40px; height: 40px; background-color: transparent; border: none; cursor: pointer; }
    .settings-input-color::-webkit-color-swatch { border-radius: 50%; border: 2px solid var(--border-color); }
    .gender-select { display: flex; gap: 10px; margin-top: 10px; justify-content: center; }
    .gender-option {
      flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 10px;
      text-align: center; cursor: pointer; transition: background 0.3s; color: var(--text-dark);
    }
    .gender-option.selected { background: var(--primary-dark); color: var(--text-light); border-color: var(--primary-dark); }
    .background-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; }
    .background-option {
        width: 100%; height: 60px; border-radius: 8px; background-size: cover;
        background-position: center; cursor: pointer; border: 2px solid transparent;
        background-color: #eee;
    }
    .background-option.selected { border-color: var(--primary-dark); }
    .toast-notification {
        position: absolute; top: -100px; left: 50%; transform: translateX(-50%);
        background-color: var(--accent-color); color: white; padding: 10px 20px;
        border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 2000; font-size: 14px; transition: top 0.5s ease-in-out;
    }


    /* --- إصلاح 3: إضافة ستايل لزر الحفظ الصغير --- */
    .save-btn {
        padding: 6px 10px; /* تصغير الحشو */
        font-size: 16px; /* حجم الأيقونة */
        min-width: 40px; /* عرض ثابت */
        flex-shrink: 0;
        margin-right: 10px; /* مسافة من النص */
    }




    /* إعدادات الوضع الليلي */
    body.dark-mode {
        --body-bg: #121212;
        --background-color: #2c3e50; --card-bg-color: #34495e; --text-dark: #ecf0f1;
        --border-color: #4a627a; --primary-dark: #3498db; --wa-recv-bubble-bg: #34495e;
        --wa-sent-bubble-bg: #056162;
    }
    body.dark-mode .chat-page { background-color: #0b141a; }
    body.dark-mode .welcome-message { background-color: rgba(0,0,0,0.2); }
    body.dark-mode .form-btn-cancel { background: #4a627a; color: var(--text-dark); }








    /* --- تعديل: تصغير النافذة المنبثقة (مودال) --- */
    .modal-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); display: flex; justify-content: center;
        align-items: center; z-index: 2000; opacity: 0; visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal-content {
        background: var(--card-bg-color); padding: 16px; /* تصغير الهوامش */
        border-radius: 16px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center;
        max-width: 90%; width: 280px; /* تصغير العرض */
    }
    .modal-title { 
        margin: 0 0 10px 0; font-size: 16px; /* تصغير الخط والهامش */
        font-weight: 700; color: var(--primary-dark); 
    }
    .modal-body { 
        margin-bottom: 16px; color: var(--text-dark); 
        font-size: 13px; /* تصغير الخط */
    }
    .modal-buttons { display: flex; gap: 10px; justify-content: center; }
    /* تصغير أزرار المودال */
    .modal-buttons .form-btn-cancel,
    .modal-buttons .form-btn-confirm {
        padding: 8px 14px;
        font-size: 13px;
    }








    /* --- تصميم خاص بالشاشات الأكبر (الكمبيوتر) --- */
    /* هذه الإعدادات تعمل فقط على الشاشات التي عرضها 600 بكسل أو أكبر */
    @media screen and (min-width: 600px) {
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-color: #d1d8e0;
        }
        body.dark-mode {
            background-color: #192a38;
        }
        .chat-container {
            max-width: 420px;
            height: 95vh;
            max-height: 850px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 1px solid #ccc;
        }
        @media (hover: hover) {
            .nav-btn:hover {
                background: rgba(255,255,255,0.15);
            }
            .member-item-wrapper:hover {
                transform: scale(1.02);
            }
        }
    }
    @media screen and (min-width: 1200px) {
        .chat-container {
            max-width: 450px;
        }
    }
  </style>
</head>
<body>
  <!-- الحاوية الرئيسية للشات -->
  <div class="chat-container">
    <!-- الشريط العلوي (الهيدر) -->
    <header class="chat-header" id="chatHeader" style="display: none;">
      <img src="https://placehold.co/44x44/0a3d62/FFF?text=S" class="avatar" alt="avatar" />
      <h1 class="title">شات شهاب</h1>
      <button class="logout-btn" id="logoutBtn">🚪 خروج</button>
    </header>
    <!-- شريط التنقل -->
    <nav class="chat-nav" id="chatNav" style="display: none;">
      <button class="nav-btn" onclick="openPage('chat', this)">الدردشة</button>
      <button class="nav-btn" onclick="openPage('members', this)">الأعضاء</button>
      <button class="nav-btn" onclick="openPage('settings', this)">الإعدادات</button>
      <button class="nav-btn" onclick="openPage('profile', this)">البروفايل</button>
    </nav>
    <!-- حاوية المحتوى الرئيسية (يتم تحميل الصفحات هنا) -->
    <main class="chat-content" id="content"></main>
    <!-- شاشة التحميل -->
    <div id="loadingScreen" style="display: none;"><div class="loading-spinner"></div></div>




    <!-- نافذة تأكيد الإجراءات (مودال) -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirmModalTitle" class="modal-title">تأكيد الإجراء</h3>
            <p id="confirmModalBody" class="modal-body">هل أنت متأكد؟</p>
            <div class="modal-buttons">
                <button id="confirmModalCancel" class="form-btn-cancel">إلغاء</button>
                <button id="confirmModalOk" class="form-btn-confirm">تأكيد</button>
            </div>
        </div>
    </div>




    <!-- نافذة إجراءات العضو (مودال) -->
    <div id="memberActionModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="memberActionTitle" class="modal-title"></h3>
            <div class="modal-buttons" style="flex-direction: column; gap: 10px;">
                <button id="memberActionViewProfile" class="settings-btn-themed" style="background: var(--primary-dark);">👤 عرض الملف الشخصي</button>
                <button id="memberActionMute" class="settings-btn-themed">🔇 تقييد الإرسال</button>
                <button id="memberActionUnmute" class="settings-btn-themed" style="background: var(--accent-color);">🔊 إلغاء التقييد</button>
                <button id="memberActionDelete" class="settings-btn-themed" style="background: var(--danger-color);">🗑️ حذف العضو</button>
                <button id="memberActionCancel" class="form-btn-cancel">إلغاء</button>
            </div>
        </div>
    </div>
  </div>








  <script type="module">
    // --- استيراد مكتبات Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, query, Timestamp, addDoc, orderBy, deleteDoc, getDocs, writeBatch, where, limitToLast } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";








    /* --- إعدادات Firebase --- */
    const firebaseConfig = {
      apiKey: "AIzaSyBnFVN-3U4NlLljUbVHHh4vQB9Mmp7RE5A",
      authDomain: "zagazig-commerce.firebaseapp.com",
      projectId: "zagazig-commerce",
      storageBucket: "zagazig-commerce.appspot.com",
      messagingSenderId: "783055989739",
      appId: "1:783055989739:web:d906f9381cb3daac2447ae"
    };








    /* --- تهيئة Firebase --- */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); // وحدة المصادقة
    const db = getFirestore(app); // وحدة قاعدة البيانات (Firestore)
    const usersCollection = collection(db, `public/data/users`);
    const messagesCollection = collection(db, `public/data/messages`);
    const globalSettingsDoc = doc(db, `public/data/global_config/settings`);








    /* --- متغيرات الحالة العامة والتخزين المؤقت --- */
    let currentUserProfile = null; // تخزين بيانات المستخدم الحالي
    let usersCache = {}; // تخزين بيانات كل المستخدمين لتقليل جلب البيانات
    let globalSettings = null; // الإعدادات العامة التي يطبقها المالك
    let pageCache = {}; // تخزين الصفحات (الدردشة، الأعضاء...) في الذاكرة
    let dataListeners = []; // مصفوفة لتخزين "مراقبي البيانات" لإيقافهم عند الخروج
    
    /* --- إصلاح 2: عدادات الصور الرمزية المتسلسلة --- */
    let maleAvatarIndex = 0;
    let femaleAvatarIndex = 0;




    /* --- جلب عناصر الصفحة الأساسية --- */
    const contentEl = document.getElementById("content");
    const headerEl = document.getElementById("chatHeader");
    const navEl = document.getElementById("chatNav");
    const loadingScreen = document.getElementById("loadingScreen");
    const logoutBtn = document.getElementById('logoutBtn');
    const memberActionModal = document.getElementById('memberActionModal');
    const memberActionTitle = document.getElementById('memberActionTitle');
    const memberActionViewProfile = document.getElementById('memberActionViewProfile');
    const memberActionMute = document.getElementById('memberActionMute');
    const memberActionUnmute = document.getElementById('memberActionUnmute');
    const memberActionDelete = document.getElementById('memberActionDelete');
    const memberActionCancel = document.getElementById('memberActionCancel');








    /* --- الصور الرمزية الافتراضية والإعدادات --- */
    const maleAvatars = [
      "https://images.pexels.com/photos/614810/pexels-photo-614810.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/91227/pexels-photo-91227.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1043471/pexels-photo-1043471.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1222271/pexels-photo-1222271.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/220453/pexels-photo-220453.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1681010/pexels-photo-1681010.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/846741/pexels-photo-846741.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1082962/pexels-photo-1082962.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
    ];
    const femaleAvatars = [
      "https://images.pexels.com/photos/733872/pexels-photo-733872.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1181519/pexels-photo-1181519.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1065084/pexels-photo-1065084.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1130626/pexels-photo-1130626.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1858175/pexels-photo-1858175.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/774909/pexels-photo-774909.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/1181686/pexels-photo-1181686.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
      "https://images.pexels.com/photos/415829/pexels-photo-415829.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop",
    ];
    
    /* --- إصلاح 1: تحديث روابط الخلفيات لنسخ عالية الجودة --- */
    const backgroundImages = [
        { thumb: 'https://images.pexels.com/photos/15286/pexels-photo.jpg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/15286/pexels-photo.jpg' },
        { thumb: 'https://images.pexels.com/photos/3408744/pexels-photo-3408744.jpeg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/3408744/pexels-photo-3408744.jpeg' },
        { thumb: 'https://images.pexels.com/photos/1287145/pexels-photo-1287145.jpeg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/1287145/pexels-photo-1287145.jpeg' },
        { thumb: 'https://images.pexels.com/photos/1766838/pexels-photo-1766838.jpeg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/1766838/pexels-photo-1766838.jpeg' },
        { thumb: 'https://images.pexels.com/photos/3225528/pexels-photo-3225528.jpeg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/3225528/pexels-photo-3225528.jpeg' },
        { thumb: 'https://images.pexels.com/photos/2098428/pexels-photo-2098428.jpeg?auto=compress&cs=tinysrgb&w=150', full: 'https://images.pexels.com/photos/2098428/pexels-photo-2098428.jpeg' },
    ];
    const defaultSettings = {
        darkMode: false, sentBubbleBg: '#e1ffc7', recvBubbleBg: '#ffffff',
        fontSize: 13, chatBackground: '', 
        bubblePadding: 1, 
    };








    /* --- دوال مساعدة (إظهار التحميل، التنبيهات...) --- */
    const showLoading = (show) => { loadingScreen.style.display = show ? 'flex' : 'none'; };
    const setActiveNav = (btn) => {
      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
      if (btn) btn.classList.add("active");
    };
    // دالة إظهار تنبيه علوي مؤقت
    const showToast = (message) => {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        document.querySelector('.chat-container').appendChild(toast);
        setTimeout(() => { toast.style.top = '20px'; }, 10);
        setTimeout(() => {
            toast.style.top = '-100px';
            setTimeout(() => { toast.remove(); }, 500);
        }, 3000);
    };


    /* --- إصلاح 2: استبدال دالة "عشوائي" بدالة "التالي" --- */
    const getNextAvatar = (gender = 'male') => {
        if (gender === 'male') {
            const avatar = maleAvatars[maleAvatarIndex];
            maleAvatarIndex = (maleAvatarIndex + 1) % maleAvatars.length; // زيادة العداد والعودة للصفر
            return avatar;
        } else {
            const avatar = femaleAvatars[femaleAvatarIndex];
            femaleAvatarIndex = (femaleAvatarIndex + 1) % femaleAvatars.length; // زيادة العداد والعودة للصفر
            return avatar;
        }
    };
    
    // دالة إظهار نافذة التأكيد
    const showConfirmModal = (title, body) => {
        return new Promise((resolve) => {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalBody').textContent = body;
            modal.classList.add('active');
            const okBtn = document.getElementById('confirmModalOk');
            const cancelBtn = document.getElementById('confirmModalCancel');
            const close = (result) => {
                modal.classList.remove('active');
                okBtn.replaceWith(okBtn.cloneNode(true));
                cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                resolve(result);
            }
            document.getElementById('confirmModalOk').onclick = () => close(true);
            document.getElementById('confirmModalCancel').onclick = () => close(false);
        });
    };




    // --- دالة جديدة: تنسيق الوقت (منذ 5 دقائق...) ---
    function formatTimeAgo(timestamp) {
        if (!timestamp) return 'غير معروف';
        const date = timestamp.toDate();
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);




        let interval = seconds / 31536000;
        if (interval > 1) return `منذ ${Math.floor(interval)} سنة`;
        interval = seconds / 2592000;
        if (interval > 1) return `منذ ${Math.floor(interval)} شهر`;
        interval = seconds / 86400;
        if (interval > 1) return `منذ ${Math.floor(interval)} يوم`;
        interval = seconds / 3600;
        if (interval > 1) return `منذ ${Math.floor(interval)} ساعة`;
        interval = seconds / 60;
        if (interval > 1) return `منذ ${Math.floor(interval)} دقيقة`;
        return 'الآن';
    }




    /* --- دالة ضغط الصور --- */
    async function compressImage(file, maxSize = 800, quality = 0.7) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;




                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }




                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(dataUrl);
                };
                img.onerror = (error) => {
                    reject(error);
                };
            };
            reader.onerror = (error) => {
                reject(error);
            };
        });
    }




    // --- دالة جديدة: تحديث حالة الاتصال ---
    async function updateUserPresence(isOnline) {
        if (!auth.currentUser) return;
        try {
            const userDocRef = doc(usersCollection, auth.currentUser.uid);
            await updateDoc(userDocRef, {
                isOnline: isOnline,
                lastSeen: Timestamp.now()
            });
        } catch (error) {
            console.warn("Failed to update presence:", error.code);
        }
    }








    /* --- دالة تطبيق إعدادات المستخدم على الواجهة --- */
    const applyUserSettings = (settings) => {
        const s = { ...defaultSettings, ...settings };
        document.body.classList.toggle('dark-mode', s.darkMode);
        const rootStyle = document.documentElement.style;
        rootStyle.setProperty('--wa-sent-bubble-bg', s.sentBubbleBg);
        rootStyle.setProperty('--wa-recv-bubble-bg', s.recvBubbleBg);
        rootStyle.setProperty('--font-size', `${s.fontSize}px`);
        
        let paddingValue = '5px 10px'; // Default (small)
        if (s.bubblePadding == 2) paddingValue = '8px 12px'; // Medium
        if (s.bubblePadding == 3) paddingValue = '12px 16px'; // Large
        rootStyle.setProperty('--bubble-padding', paddingValue);


        if (pageCache.chat) { 
            const bgValue = s.chatBackground 
                ? `url(${s.chatBackground})` 
                : 'none';
            pageCache.chat.style.backgroundImage = bgValue;
        }
    };




    /* --- === [!!] هذا هو الإصلاح [!!] === ---
     * تم تعديل هذه الدالة لإعطاء الأولوية للخط والحجم الشخصي دائماً
     * --- === نهاية الإصلاح === ---
     */
    const applyCombinedSettings = () => {
        if (!currentUserProfile) return;
        
        // 1. جلب الإعدادات الشخصية
        const userSettings = { ...defaultSettings, ...(currentUserProfile.settings || {}) };
        
        /* --- === [!!] إصلاح الطلب 2 [!!] === ---
         * تم تعديل هذه الدالة لتطبيق الإعدادات الشخصية فقط
         * هذا يجعل المستخدمين الحاليين غير متأثرين بالمظهر العام
         */
        
        // 2. تطبيق الإعدادات الشخصية للمستخدم. فقط.
        applyUserSettings(userSettings);
    };








    /* --- دالة إيقاف مراقبة البيانات (عند تسجيل الخروج) --- */
    function detachAllListeners() {
        dataListeners.forEach(unsubscribe => unsubscribe());
        dataListeners = [];
    }








    /* --- الدالة الرئيسية لتهيئة التطبيق بعد التحقق من تسجيل الدخول --- */
    async function initializeAppState(user) {
        detachAllListeners(); // إيقاف أي مراقبات سابقة




        // إذا لم يكن هناك مستخدم (تم تسجيل الخروج)
        if (!user) {
            currentUserProfile = null;
            headerEl.style.display = "none";
            navEl.style.display = "none";
            contentEl.innerHTML = "";
            pageCache = {};
            showWelcomePage(); // إظهار صفحة الدخول
            return;
        }




        // إذا كان هناك مستخدم
        showLoading(true);
        try {
            const userDocRef = doc(usersCollection, user.uid);
            const userDoc = await getDoc(userDocRef);




            if (userDoc.exists()) {
                // المستخدم موجود ولديه بروفايل
                currentUserProfile = { id: user.uid, ...userDoc.data() };
                
                updateUserPresence(true); 
                
                document.addEventListener("visibilitychange", () => {
                    if (!auth.currentUser) return;
                    const isOnline = document.visibilityState === "visible";
                    updateUserPresence(isOnline);
                });




                buildPageCache(); // بناء حاويات الصفحات
                attachDataListeners(user.uid); // بدء مراقبة البيانات




                applyCombinedSettings(); // تطبيق الإعدادات
                updateHeaderUI(currentUserProfile); // تحديث الهيدر
                headerEl.style.display = "flex";
                navEl.style.display = "flex";
                logoutBtn.onclick = handleLogout;
                openPage('chat', document.querySelector('.nav-btn')); // فتح صفحة الشات
            } else {
                // المستخدم جديد، ليس لديه بروفايل
                headerEl.style.display = "none";
                navEl.style.display = "none";
                showNewUserProfilePage(user); // إظهار صفحة إكمال البروفايل
            }
        } catch (error) {
            console.error("Error initializing app state:", error);
            showToast("حدث خطأ أثناء تحميل البيانات.");
        } finally {
            showLoading(false);
        }
    }








    /* --- مراقبة تغيير حالة تسجيل الدخول --- */
    onAuthStateChanged(auth, initializeAppState);








    /* --- دوال تسجيل الدخول والخروج --- */
    const handleLogin = async () => {
        showLoading(true);
        try { await signInAnonymously(auth); } // تسجيل دخول مجهول
        catch (error) { console.error("Anonymous sign-in failed:", error); showLoading(false); }
    };




    const handleLogout = async () => {
        showLoading(true);
        try { 
            if (auth.currentUser) { 
                await updateUserPresence(false);
            }
            await signOut(auth); // تسجيل الخروج
        } 
        catch (error) { console.error("Sign out error", error); } 
        finally { showLoading(false); }
    };




    /* --- دالة بدء مراقبة البيانات (الرسائل، المستخدمين...) --- */
    function attachDataListeners(userId) {
        if (dataListeners.length > 0) return; // منع تكرار المراقبة




        // 1. مراقبة ملف المستخدم الحالي
        const userDocRef = doc(usersCollection, userId);
        const unsubscribeProfile = onSnapshot(userDocRef, (doc) => {
            if (!doc.exists()) return; 
            currentUserProfile = { id: userId, ...doc.data() };
            usersCache[userId] = currentUserProfile;
            applyCombinedSettings();
            updateHeaderUI(currentUserProfile);
            if (pageCache.profile && pageCache.profile.classList.contains('active')) {
                renderProfilePage(true);
            }
            if (pageCache.members && pageCache.members.classList.contains('active')) {
                renderMembersList();
            }
        });




        // 2. مراقبة الإعدادات العامة (للمالك)
        // [ملاحظة: هذه الدالة الآن تراقب المظهر العام فقط لاستخدامه للمستخدمين الجدد]
        const unsubscribeGlobalSettings = onSnapshot(globalSettingsDoc, (doc) => {
            globalSettings = doc.exists() ? doc.data() : null;
            if (currentUserProfile) {
                // [تم التعديل] لم نعد نطبق المظهر العام على المستخدمين الحاليين
                // applyCombinedSettings(); // <--- تم إلغاء هذا السطر
            }
        });




        // 3. مراقبة كل المستخدمين (لقائمة الأعضاء)
        const usersQuery = query(usersCollection, orderBy("name"));
        const unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
            let listChanged = false;
            snapshot.docChanges().forEach(change => {
                listChanged = true;
                const user = { id: change.doc.id, ...change.doc.data() };
                if (change.type === 'removed') delete usersCache[user.id];
                else usersCache[user.id] = user;
            });
            // إذا تغيرت قائمة المستخدمين (أو حالة اتصالهم)
            if (listChanged && pageCache.members && pageCache.members.classList.contains('active')) {
                renderMembersList(); // أعد رسم قائمة الأعضاء
            }
        });




        // 4. مراقبة الرسائل الجديدة
        let isInitialMessagesLoad = true;
        const messagesQuery = query(messagesCollection, orderBy("createdAt"), limitToLast(50));




        const unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
            const messagesEl = pageCache.chat.querySelector('.messages');
            if (!messagesEl) return; 




            const welcome = messagesEl.querySelector('.welcome-message');
            const isScrolledUp = messagesEl.scrollHeight - messagesEl.clientHeight > messagesEl.scrollTop + 150;




            if (!snapshot.empty && !messagesEl.querySelector('.load-more-btn')) {
                 const loadMoreContainer = document.createElement('div');
                 loadMoreContainer.className = 'load-more-container';
                 loadMoreContainer.innerHTML = `<button class="load-more-btn" disabled>جاري تحميل الرسائل...</button>`;
                 messagesEl.prepend(loadMoreContainer);
                 setTimeout(() => {
                     const btn = messagesEl.querySelector('.load-more-btn');
                     if(btn) btn.textContent = 'لا توجد رسائل أقدم';
                 }, 2000);
            }




            if (snapshot.empty && welcome) {
                welcome.innerHTML = `<h3>لا توجد رسائل بعد</h3><p>ابدأ الدردشة الآن!</p>`;
            } else if (welcome) {
                welcome.remove();
            }




            let newMessagesAdded = false;
            snapshot.docChanges().forEach((change) => {
                const msgData = { id: change.doc.id, ...change.doc.data() };
                const msgEl = messagesEl.querySelector(`[data-msg-id="${msgData.id}"]`);
                if (change.type === "added" && !msgEl) {
                    const newMsgEl = createMessageElement(msgData);
                    if (newMsgEl) {
                        messagesEl.appendChild(newMsgEl); 
                        newMessagesAdded = true;
                    }
                }
                if (change.type === "removed" && msgEl) msgEl.remove();
            });




            // دالة التمرير لأسفل
            const scrollToBottom = () => {
                setTimeout(() => {
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }, 0);
            };




            if (newMessagesAdded) {
                if (isInitialMessagesLoad || !isScrolledUp) {
                    scrollToBottom();
                }
            } else if (isInitialMessagesLoad) {
                scrollToBottom();
            }




            isInitialMessagesLoad = false; 
        }, (error) => {
            console.error("Messages listener failed:", error);
            showToast("خطأ في تحديث الرسائل.");
        });




        // إضافة كل المراقبات للمصفوفة لإيقافها لاحقاً
        dataListeners.push(unsubscribeProfile, unsubscribeGlobalSettings, unsubscribeUsers, unsubscribeMessages);
    };








    /* --- دالة بناء حاويات الصفحات (الدردشة، الأعضاء...) --- */
    function buildPageCache() {
        contentEl.innerHTML = '';
        pageCache.chat = createChatPage();
        pageCache.members = createMembersPage();
        pageCache.settings = createSettingsPage();
        pageCache.profile = createProfilePage();
        pageCache.view_profile = document.createElement('div');
        pageCache.view_profile.id = 'view_profile_page';
        pageCache.view_profile.className = 'page page-container';
        pageCache.edit_profile = document.createElement('div');
        pageCache.edit_profile.id = 'edit_profile_page';
        pageCache.edit_profile.className = 'page';
        Object.values(pageCache).forEach(p => contentEl.appendChild(p));
    }




    /* --- دالة التنقل بين الصفحات --- */
    window.openPage = (pageName, btn) => {
        if (!auth.currentUser || !currentUserProfile) return;
        if (btn) setActiveNav(btn);
        preparePageForDisplay(pageName); // تحضير المحتوى قبل العرض
        Object.values(pageCache).forEach(p => p.classList.remove('active'));
        const targetPage = pageCache[pageName];
        if (targetPage) targetPage.classList.add('active');
    };




    // دالة تحضير المحتوى (تُستخدم لتحديث المحتوى المتغير مثل قائمة الأعضاء)
    function preparePageForDisplay(pageName) {
        switch (pageName) {
            case 'settings': renderSettingsPage(true); break;
            case 'profile': renderProfilePage(true); break;
            case 'members': renderMembersList(); break; 
            case 'edit_profile': renderEditProfilePage(); break;
        }
    }








    /* --- دوال إنشاء محتوى الصفحات --- */
    function createChatPage() {
        const page = document.createElement('div');
        page.id = 'chat';
        page.className = 'page chat-page';
        page.innerHTML = `<div class="messages" id="messages"><div class="welcome-message"><h3>أهلاً بك!</h3><p>جاري تحميل الرسائل...</p></div></div><form class="chat-input" id="messageForm"><input class="msg-input" id="msgInput" type="text" placeholder="اكتب رسالتك..." autocomplete="off" /><button class="send-btn" type="submit" title="إرسال">➤</button></form>`;
        page.querySelector('#messageForm').addEventListener('submit', sendMessage);
        return page;
    }




    function createMembersPage() {
        const page = document.createElement('div');
        page.id = 'members';
        page.className = 'page page-container';
        page.innerHTML = `<div class="search-bar"><input id="searchInput" type="text" placeholder="ابحث عن عضو..."/></div><div id="membersList" class="members-list"></div>`;
        page.querySelector('#searchInput').addEventListener('input', filterMembersList);
        return page;
    }




    function createProfilePage() {
        const page = document.createElement('div');
        page.id = 'profile';
        page.className = 'page page-container';
        return page;
    }




    function createSettingsPage() {
        const page = document.createElement('div');
        page.id = 'settings';
        page.className = 'page page-container';
        return page;
    }








    /* --- دوال التعامل مع الإجراءات (حذف رسالة، حذف عضو...) --- */
    async function handleDeleteMessage(messageId) {
        if(await showConfirmModal('حذف الرسالة', 'هل أنت متأكد من حذف هذه الرسالة بشكل نهائي؟')) {
            try { await deleteDoc(doc(messagesCollection, messageId)); showToast('تم حذف الرسالة.'); } 
            catch (error) { console.error("Error deleting message:", error); showToast('فشل حذف الرسالة.'); }
        }
    }




    async function handleDeleteMember(userId, userName) {
        if(await showConfirmModal('حذف العضو', `هل أنت متأكد من حذف العضو "${userName}" وكل رسائله بشكل نهائي؟`)) {
            showLoading(true);
            try {
                // حذف رسائل العضو
                const messagesQuery = query(messagesCollection, where("senderId", "==", userId));
                const messagesSnapshot = await getDocs(messagesQuery);
                const batch = writeBatch(db);
                messagesSnapshot.forEach(doc => batch.delete(doc.ref));
                // حذف ملف العضو
                batch.delete(doc(usersCollection, userId));
                await batch.commit(); // تنفيذ العمليتين معاً
                showToast(`تم حذف ${userName} وكل رسائله بنجاح.`);
            } catch (error) {
                console.error("Error deleting member:", error); showToast('حدث خطأ أثناء حذف العضو.');
            } finally { showLoading(false); }
        }
    }




    // إظهار نافذة إجراءات العضو (تقييد، حذف...)
    function showMemberActionModal(user) {
        memberActionTitle.textContent = user.name;
        memberActionMute.style.display = user.isMuted ? 'none' : 'block';
        memberActionUnmute.style.display = user.isMuted ? 'block' : 'none';




        memberActionViewProfile.onclick = () => {
            memberActionModal.classList.remove('active');
            viewUserProfile(user.id);
        };
        memberActionMute.onclick = () => handleSetMute(user.id, true);
        memberActionUnmute.onclick = () => handleSetMute(user.id, false);
        memberActionDelete.onclick = () => {
            memberActionModal.classList.remove('active'); 
            handleDeleteMember(user.id, user.name); 
        };
        memberActionCancel.onclick = () => memberActionModal.classList.remove('active');




        memberActionModal.classList.add('active');
    }




    // دالة تقييد العضو (كتم)
    async function handleSetMute(userId, isMuted) {
        try {
            await updateDoc(doc(usersCollection, userId), { isMuted: isMuted });
            showToast(isMuted ? 'تم تقييد العضو بنجاح.' : 'تم إلغاء تقييد العضو.');
            if(usersCache[userId]) {
                usersCache[userId].isMuted = isMuted; 
            }
            renderMembersList(); 
        } catch (error) {
            console.error("Error setting mute state:", error);
            showToast('حدث خطأ.');
        } finally {
            memberActionModal.classList.remove('active');
        }
    }




    /* --- === [!!] إصلاح الطلب 1: ترتيب الأعضاء [!!] === --- */
    function renderMembersList() {
        if (!pageCache.members) return;
        const membersListEl = pageCache.members.querySelector('#membersList');
        membersListEl.innerHTML = ''; 
        const fragment = document.createDocumentFragment();
        const isAdmin = currentUserProfile.badge === 'owner' || currentUserProfile.badge === 'moderator';




        // 1. تحويل الكاش إلى مصفوفة وحساب حالة الاتصال الحقيقية
        const allUsers = Object.values(usersCache).map(user => {
            const minutesAgo = user.lastSeen ? (new Date() - user.lastSeen.toDate()) / 60000 : Infinity;
            const trulyOnline = user.isOnline && minutesAgo < 2;
            return { ...user, trulyOnline }; // إضافة الحالة للمستخدم
        });




        // 2. ترتيب المصفوفة: المتصلون أولاً، ثم أبجدياً
        allUsers.sort((a, b) => {
            if (a.trulyOnline && !b.trulyOnline) return -1; // 'a' متصل، 'b' غير متصل -> 'a' يأتي أولاً
            if (!a.trulyOnline && b.trulyOnline) return 1;  // 'b' متصل، 'a' غير متصل -> 'b' يأتي أولاً
            return a.name.localeCompare(b.name); // إذا كانت حالتهما واحدة، رتب أبجدياً
        });




        // 3. عرض القائمة المرتبة
        allUsers.forEach(user => {
            const memberItemWrapper = document.createElement('div');
            memberItemWrapper.className = 'member-item-wrapper';
            memberItemWrapper.dataset.userId = user.id;




            const memberItem = document.createElement('div');
            memberItem.className = 'member-item';




            const muteIcon = user.isMuted ? ' 🔇' : '';
            // نستخدم القيمة التي حسبناها مسبقاً
            const statusClass = user.trulyOnline ? 'online' : '';
            const statusText = user.trulyOnline 
                ? 'متصل الآن' 
                : (user.lastSeen ? formatTimeAgo(user.lastSeen) : 'غير متصل');
            
            memberItem.innerHTML = `
                <img class="member-avatar" src="${user.avatar}" alt="${user.name}" />
                <div class="member-info">
                    <h3 class="member-name">${user.name}${muteIcon}</h3>
                    <div class="member-status">${statusText}</div>
                </div>
                <div class="status-dot ${statusClass}"></div>
            `;




            // إذا كان المستخدم الحالي أدمن AND العضو الظاهر ليس هو نفسه
            if (isAdmin && user.id !== currentUserProfile.id) {
                memberItem.onclick = () => showMemberActionModal(user); // إظهار نافذة الإجراءات
            } else {
                memberItem.onclick = () => viewUserProfile(user.id); // إظهار بروفايل العضو
            }




            memberItemWrapper.appendChild(memberItem);
            fragment.appendChild(memberItemWrapper);
        });
        /* --- === نهاية إصلاح الطلب 1 === --- */
        
        membersListEl.appendChild(fragment);
        filterMembersList(); // تطبيق فلتر البحث
    }




    // دالة فلترة قائمة الأعضاء (البحث)
    function filterMembersList() {
        if (!pageCache.members) return;
        const searchInput = pageCache.members.querySelector('#searchInput');
        const searchTerm = searchInput.value.toLowerCase().trim();
        const membersListEl = pageCache.members.querySelector('#membersList');




        membersListEl.querySelectorAll('.member-item-wrapper').forEach(wrapper => {
            const nameEl = wrapper.querySelector('.member-name');
            if (nameEl) {
                const name = nameEl.textContent.toLowerCase();
                wrapper.style.display = (searchTerm && !name.includes(searchTerm)) ? 'none' : 'flex';
            }
        });
    }




    /* --- دالة عرض صفحة البروفايل --- */
    function renderProfilePage(rerender = false) {
        if (!pageCache.profile || !currentUserProfile) return;
        if (rerender || !pageCache.profile.innerHTML) {
            pageCache.profile.innerHTML = createUserProfileViewHTML(currentUserProfile, true);
            pageCache.profile.querySelector('#editProfileBtn').onclick = () => openPage('edit_profile');
        }
    }








    /* --- دالة عرض صفحة الإعدادات --- */
    function renderSettingsPage(rerender = false) {
        if (!pageCache.settings || !rerender) return;
        const settings = { ...defaultSettings, ...(currentUserProfile.settings) };
        let ownerSectionHTML = '';
        if (currentUserProfile.badge === 'owner') {
            ownerSectionHTML = `<div class="settings-section"><h2 class="settings-section-title">👑 أدوات المالك</h2><div class="settings-option"><button id="applyToAllBtn" class="form-btn-confirm" style="flex:1;">تطبيق مظهري (للمستخدمين الجدد)</button></div><div class="settings-option"><button id="resetAllBtn" class="form-btn-cancel" style="flex:1;">إلغاء المظهر العام</button></div><div class="settings-option"><button id="clearChatBtn" class="settings-btn-themed" style="background: var(--danger-color); flex:1;">مسح الشات بالكامل</button></div></div>`;
        }
        
        const bubblePaddingText = settings.bubblePadding == 1 ? 'صغير' : (settings.bubblePadding == 2 ? 'وسط' : 'كبير');


        pageCache.settings.innerHTML = `<div class="settings-section"><h2 class="settings-section-title">المظهر العام</h2><div class="settings-option"><span class="label">الوضع الليلي</span><input type="checkbox" id="darkModeToggle" ${settings.darkMode ? 'checked' : ''}/></div><div class="settings-option"><span class="label">لون فقاعاتي</span><input type="color" class="settings-input-color" id="sentBubbleColor" value="${settings.sentBubbleBg}"></div><div class="settings-option"><span class="label">لون فقاعات الآخرين</span><input type="color" class="settings-input-color" id="recvBubbleColor" value="${settings.recvBubbleBg}"></div>
        
        <div class="settings-option">
            <span class="label">حجم الخط</span>
            <input type="range" id="fontSizeRange" min="12" max="20" value="${settings.fontSize}" style="flex:1" />
            <span id="fontSizeValue" style="min-width: 40px; text-align: left;">${settings.fontSize}px</span>
            <button class="settings-btn-themed save-btn" id="saveFontSize" title="حفظ">💾</button>
        </div>
        
        <div class="settings-option">
            <span class="label">حجم بطاقة الرسالة</span>
            <input type="range" id="bubblePaddingRange" min="1" max="3" value="${settings.bubblePadding}" style="flex:1" />
            <span id="bubblePaddingValue" style="min-width: 40px; text-align: left;">${bubblePaddingText}</span>
            <button class="settings-btn-themed save-btn" id="saveBubblePadding" title="حفظ">💾</button>
        </div>


        </div><div class="settings-section"><h2 class="settings-section-title">خلفية الدردشة</h2><div class="background-grid" id="backgroundGrid">${backgroundImages.map(img => `<div class="background-option" style="background-image: url(${img.thumb})" data-url="${img.full}"></div>`).join('')}</div><div class="settings-option" style="padding-top: 16px;"><label for="bgUpload" class="settings-btn-themed" style="flex:1; text-align:center; cursor:pointer; background: var(--accent-color);">رفع خلفية خاصة</label><input type="file" id="bgUpload" accept="image/*" style="display:none;"></div><div class="settings-option" style="padding-top: 8px;"><button class="settings-btn-themed" id="resetBgBtn" style="background: var(--danger-color); flex:1;">مسح الخلفية</button></div></div>${ownerSectionHTML}<div class="settings-section"><h2 class="settings-section-title">وسام الإدارة</h2><div class="settings-option"><input type="password" id="badgePass" class="auth-input" placeholder="أدخل كلمة المرور" style="flex:1"/><button id="badgeSaveBtn" class="settings-btn-themed">حفظ</button></div></div><div class="settings-section"><h2 class="settings-section-title">إعادة الضبط</h2><div class="settings-option"><button id="resetAllSettings" class="settings-btn-themed" style="background: var(--danger-color); flex:1;">إعادة ضبط كل إعداداتي</button></div></div>`;
        


        addSettingsEventListeners(); // ربط الأوامر بالأزرار الجديدة
    }








    /* --- دوال صفحات تسجيل الدخول وإنشاء بروفايل جديد --- */
    const showWelcomePage = () => {
      contentEl.innerHTML = `<div class="auth-page"><h1 class="auth-title">أهلاً بك في شات شهاب</h1><div class="auth-card" style="text-align:center;"><p>ادخل للدردشة مباشرة مع الأصدقاء</p><button id="loginBtn" class="form-btn-confirm" style="width:100%;">ادخل الآن</button></div></div>`;
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
    };




    // إظهار صفحة إكمال البروفايل للمستخدم الجديد
    const showNewUserProfilePage = (user) => {
      contentEl.innerHTML = ''; 
      const title = 'أكمل ملفك الشخصي';
      const buttonText = 'دخول الدردشة';
      /* --- إصلاح 2: استخدام الدالة الجديدة لإظهار أول صورة --- */
      const p = { name: '', avatar: getNextAvatar('male'), gender: 'male', location: '' };


      const formContainer = document.createElement('div');




      formContainer.innerHTML = `<div class="auth-page"><h1 class="auth-title">${title}</h1><form class="auth-card" id="profileForm">
        
        <div style="display:flex; flex-direction:column; align-items:center; gap:4px;">
          <label for="avatarUpload">
            <img class="signup-avatar" id="avatarPreview" src="${p.avatar}" alt="Avatar" title="اضغط لرفع صورة" />
          </label>
          <p class="avatar-note">اضغط على الصورة لرفع صورة من جهازك</p>
          <input type="file" id="avatarUpload" accept="image/*" style="display:none;">
          <input type="hidden" name="avatar" value="${p.avatar}">
          <button type="button" class="settings-btn-themed" id="randomAvatarBtn" style="margin-top: 8px;">صورة رمزية تالية</button>
        </div>




        <div class="auth-input-group" style="width:100%;"><label for="nameInput">اسمك في الشات</label><input type="text" id="nameInput" name="name" class="auth-input" value="${p.name}" placeholder="اكتب اسمك هنا..." /></div>
        <div class="auth-input-group" style="width:100%;"><label for="locationInput">العنوان</label><input type="text" id="locationInput" name="location" class="auth-input" value="${p.location || ''}" placeholder="مثال: القاهرة، مصر" /></div>
        <div class="gender-select"><div class="gender-option ${p.gender === 'male' ? 'selected' : ''}" data-gender="male">ذكـر</div><div class="gender-option ${p.gender === 'female' ? 'selected' : ''}" data-gender="female">أنثـى</div></div>
        <p class="error-message" id="setupError"></p>
        <div class="form-btn-group"><button type="submit" class="form-btn-confirm">${buttonText}</button></div>
      </form></div>`;




      contentEl.appendChild(formContainer);
      const form = document.getElementById('profileForm');
      attachProfileFormListeners(form, false); // ربط الأوامر (رفع الصورة، اختيار الجنس)
      form.addEventListener('submit', (e) => handleProfileSave(e, user, false));
    };




    // إظهار صفحة تعديل البروفايل
    function renderEditProfilePage() {
        if (!pageCache.edit_profile || !currentUserProfile) return;
        const p = currentUserProfile;
        const title = 'تعديل الملف الشخصي';
        const buttonText = 'حفظ التعديلات';




        pageCache.edit_profile.innerHTML = `<div class="auth-page"><h1 class="auth-title">${title}</h1><form class="auth-card" id="editProfileForm">
        
        <div style="display:flex; flex-direction:column; align-items:center; gap:4px;">
          <label for="editAvatarUpload">
            <img class="signup-avatar" id="editAvatarPreview" src="${p.avatar}" alt="Avatar" title="اضغط لتغيير الصورة" />
          </label>
          <p class="avatar-note">اضغط على الصورة لرفع صورة من جهازك</p>
          <input type="file" id="editAvatarUpload" accept="image/*" style="display:none;">
          <input type="hidden" name="avatar" value="${p.avatar}">
          <button type="button" class="settings-btn-themed" id="editRandomAvatarBtn" style="margin-top: 8px;">صورة رمزية تالية</button>
        </div>




        <div class="auth-input-group" style="width:100%;"><label for="editNameInput">اسمك في الشات</label><input type="text" id="editNameInput" name="name" class="auth-input" value="${p.name}" placeholder="اكتب اسمك هنا..." /></div>
        <div class="auth-input-group" style="width:100%;"><label for="editLocationInput">العنوان</label><input type="text" id="editLocationInput" name="location" class="auth-input" value="${p.location || ''}" placeholder="مثال: القاهرة، مصر" /></div>
        <div class="gender-select"><div class="gender-option ${p.gender === 'male' ? 'selected' : ''}" data-gender="male">ذكـر</div><div class="gender-option ${p.gender === 'female' ? 'selected' : ''}" data-gender="female">أنثـى</div></div>
        <p class="error-message" id="editError"></p>
        <div class="form-btn-group"><button type="button" class="form-btn-cancel">إلغاء</button><button type="submit" class="form-btn-confirm">${buttonText}</button></div>
        </form></div>`;




        const form = pageCache.edit_profile.querySelector('#editProfileForm');
        form.querySelector('.form-btn-cancel').onclick = () => openPage('profile');
        attachProfileFormListeners(form, true); // ربط الأوامر (رفع الصورة، اختيار الجنس)
        form.addEventListener('submit', (e) => handleProfileSave(e, auth.currentUser, true));
    }




    // دالة ربط الأوامر بصفحة البروفايل (لرفع الصور واختيار الجنس)
    function attachProfileFormListeners(form, isEditing = false) {
      const avatarUploadInput = form.querySelector(isEditing ? '#editAvatarUpload' : '#avatarUpload');
      const avatarPreview = form.querySelector(isEditing ? '#editAvatarPreview' : '#avatarPreview');
      const randomAvatarBtn = form.querySelector(isEditing ? '#editRandomAvatarBtn' : '#randomAvatarBtn');
      const avatarHiddenInput = form.querySelector('[name="avatar"]');
      
      /* --- إصلاح 2: تغيير اسم الزر --- */
      randomAvatarBtn.textContent = 'صورة رمزية تالية';




      // عند اختيار ملف صورة
      avatarUploadInput.addEventListener('change', async (event) => {
          const file = event.target.files[0];
          if (!file) return;




          showLoading(true);
          try {
              const compressedBase64 = await compressImage(file, 800, 0.7); // ضغط الصورة




              if (compressedBase64.length > 700 * 1024) { 
                  showToast("الصورة كبيرة جداً حتى بعد الضغط. حاول بصورة أخرى.");
                  avatarUploadInput.value = '';
                  showLoading(false);
                  return;
              }




              avatarPreview.src = compressedBase64; // عرض الصورة المضغوطة
              avatarHiddenInput.value = compressedBase64; // تخزينها (كنص)
              randomAvatarBtn.style.display = 'none'; // إخفاء زر العشوائي
          } catch (error) {
              console.error("Image compression failed:", error);
              showToast("حدث خطأ أثناء ضغط الصورة.");
          } finally {
              showLoading(false);
          }
      });




      /* --- إصلاح 2: تعديل دالة `updateAvatar` لاستخدام `getNextAvatar` --- */
      const updateAvatar = () => {
          const gender = form.querySelector('.gender-option.selected').dataset.gender;
          const newAvatar = getNextAvatar(gender); 
          avatarPreview.src = newAvatar;
          avatarHiddenInput.value = newAvatar;
          randomAvatarBtn.style.display = 'block'; 
      };
      
      randomAvatarBtn.addEventListener('click', async () => {
          randomAvatarBtn.disabled = true;
          randomAvatarBtn.textContent = '...';
          await new Promise(resolve => setTimeout(resolve, 10)); 




          try {
              updateAvatar();
              
              await new Promise((resolve) => {
                  avatarPreview.onload = resolve;
                  avatarPreview.onerror = () => {
                      console.error("Failed to load next avatar image.");
                      resolve(); 
                  };
              });
              
          } catch (error) {
              console.error("Error in next avatar click:", error);
          } finally {
              randomAvatarBtn.disabled = false;
              randomAvatarBtn.textContent = 'صورة رمزية تالية';
          }
      });




      form.querySelectorAll('.gender-option').forEach(option => {
          option.addEventListener('click', async () => { 
              form.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('selected'));
              option.classList.add('selected');
              
              randomAvatarBtn.disabled = true;
              randomAvatarBtn.textContent = '...';
              await new Promise(resolve => setTimeout(resolve, 10));




              try {
                  updateAvatar(); 
                  await new Promise((resolve) => { 
                      avatarPreview.onload = resolve;
                      avatarPreview.onerror = resolve;
                  });
              } finally {
                  randomAvatarBtn.disabled = false;
                  randomAvatarBtn.textContent = 'صورة رمزية تالية';
              }
          });
      });
    }








    /* --- دالة حفظ البروفايل (جديد أو تعديل) --- */
    const handleProfileSave = async (event, user, isEditing = false) => {
      event.preventDefault();
      const form = event.target;
      const name = form.querySelector('[name="name"]').value.trim();
      if (!name) { 
        form.querySelector('.error-message').textContent = "الرجاء إدخال اسم.";
        form.querySelector('.error-message').style.display = 'block'; 
        return;
      }
      showLoading(true);
      form.querySelector('.error-message').style.display = 'none';




      try {
        const userRef = doc(usersCollection, user.uid);
        const data = { 
            name, 
            gender: form.querySelector('.gender-option.selected').dataset.gender, 
            location: form.querySelector('[name="location"]').value.trim() 
        };
        data.avatar = form.querySelector('[name="avatar"]').value; 




        if (isEditing) {
            await updateDoc(userRef, data);
            showToast("تم حفظ التعديلات بنجاح!");
            openPage('profile'); 
        } else {
            data.badge = null; 
            
            /* --- === [!!] إصلاح الطلب 2: المظهر للمستخدم الجديد [!!] === --- */
            // التحقق إذا كان المالك قد وضع مظهراً عاماً
            if (globalSettings) {
                // المستخدم الجديد يحصل على المظهر العام كإعدادات افتراضية
                // ندمجها مع الإعدادات الافتراضية لضمان وجود كل الخصائص
                data.settings = { ...defaultSettings, ...globalSettings };
            } else {
                // لا يوجد مظهر عام، المستخدم يحصل على الإعدادات الافتراضية العادية
                data.settings = defaultSettings; 
            }
            /* --- === نهاية إصلاح الطلب 2 === --- */
            
            data.createdAt = Timestamp.now();
            data.isMuted = false; 
            data.isOnline = true;
            data.lastSeen = Timestamp.now();
            await setDoc(userRef, data);
            await initializeAppState(user); 
        }
      } catch (error) {
        console.error("Profile save failed:", error); 
        form.querySelector('.error-message').textContent = "فشل حفظ البيانات.";
      } finally {
        showLoading(false);
      }
    };








    // دالة عرض بروفايل مستخدم آخر
    window.viewUserProfile = (userId) => {
        const user = usersCache[userId];
        if (user && pageCache.view_profile) {
            pageCache.view_profile.innerHTML = createUserProfileViewHTML(user, false);
            pageCache.view_profile.querySelector('.back-btn').onclick = () => openPage('members');
            Object.values(pageCache).forEach(p => p.classList.remove('active'));
            pageCache.view_profile.classList.add('active');
        }
    }








    // دالة إنشاء كود العرض للبروفايل
    function createUserProfileViewHTML(user, isOwnProfile = false) {
        const buttonsHTML = isOwnProfile 
            ? `<button class="profile-edit-btn" id="editProfileBtn" style="margin-top: 16px;">تعديل الملف الشخصي</button>`
            : `<button class="form-btn-confirm back-btn">العودة للأعضاء</button>`;
        return `<div class="card-section"><img class="view-profile-avatar" src="${user.avatar}" alt="${user.name}" /><h2 class="profile-name">${user.name}</h2></div><div class="profile-details-section"><div class="profile-detail-item"><span class="label">الجنس</span><span class="value">${user.gender === 'male' ? 'ذكر' : 'أنثى'}</span></div><div class="profile-detail-item"><span class="label">العنوان</span><span class="value">${user.location || 'غير محدد'}</span></div></div>${buttonsHTML}`;
    }




    /* --- دالة ربط الأوامر بأزرار صفحة الإعدادات --- */
    function addSettingsEventListeners() {
        const page = pageCache.settings;
        if (!page) return;




        /* --- === [!!] هذا هو الإصلاح [!!] === ---
         * تم إرجاع التحديث الفوري المحلي هنا
         * --- === نهاية الإصلاح === ---
         */
        const updateSettings = async (newSetting) => {
            if (!currentUserProfile) return; 
            
            // 1. نقوم بإنشاء نسخة محدثة من الإعدادات بناءً على الحالة الحالية
            const updatedSettings = { ...defaultSettings, ...(currentUserProfile.settings || {}), ...newSetting };
            
            try { 
                // 2. [الإصلاح] تحديث الحالة المحلية *فوراً*
                currentUserProfile.settings = updatedSettings; 
                
                // 3. [الإصلاح] تطبيق الإعدادات *فوراً* على الواجهة
                applyCombinedSettings(); 
                
                // 4. الآن، نحفظ في قاعدة البيانات (في الخلفية)
                // المراقب سيجلبها لاحقاً لكن الواجهة تحدثت بالفعل
                await updateDoc(doc(usersCollection, currentUserProfile.id), { settings: updatedSettings }); 
            } 
            catch (error) { console.error("Failed to save settings:", error); }
        };




        // --- ربط أوامر المالك ---
        if (currentUserProfile.badge === 'owner') {
            page.querySelector('#applyToAllBtn').addEventListener('click', async () => { 
                showLoading(true); 
                try { 
                    const settingsToApply = { ...currentUserProfile.settings };
                    // نحذف الإعدادات الشخصية البحتة من المظهر العام
                    delete settingsToApply.darkMode; 
                    delete settingsToApply.chatBackground; 
                    await setDoc(globalSettingsDoc, settingsToApply); 
                    showToast("تم حفظ المظهر العام للمستخدمين الجدد!"); 
                } catch (e) { showToast("حدث خطأ."); } finally { showLoading(false); } 
            });




            page.querySelector('#resetAllBtn').addEventListener('click', async () => { 
                showLoading(true); 
                try { 
                    await deleteDoc(globalSettingsDoc); 
                    showToast("تم إلغاء المظهر العام للمستخدمين الجدد."); 
                } catch (e) { showToast("حدث خطأ."); } finally { showLoading(false); } 
            });




            page.querySelector('#clearChatBtn').addEventListener('click', async () => {
                if(await showConfirmModal("مسح الشات بالكامل", "هل أنت متأكد من حذف جميع رسائل الشات للجميع بشكل نهائي؟")){
                    showLoading(true);
                    try {
                        const allMessages = await getDocs(query(messagesCollection));
                        const batch = writeBatch(db);
                        allMessages.forEach(doc => batch.delete(doc.ref)); 
                        await batch.commit();
                        showToast("تم مسح الشات بنجاح!");
                    } catch(e) { console.error(e); showToast("حدث خطأ أثناء مسح الشات."); }
                    finally { showLoading(false); }
                }
            });
        }




        // --- ربط أوامر الإعدادات العادية ---




        // رفع خلفية خاصة
        const bgUploadInput = page.querySelector('#bgUpload');
        bgUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            showLoading(true);
            try {
                const compressedBase64 = await compressImage(file, 1200, 0.6); 
                if (compressedBase64.length > 700 * 1024) { 
                     showToast("الصورة كبيرة جداً حتى بعد الضغط.");
                     bgUploadInput.value = '';
                     showLoading(false);
                     return;
                }
                updateSettings({ chatBackground: compressedBase64 }); 
                page.querySelectorAll('.background-option').forEach(opt => opt.classList.remove('selected'));
                showToast("تم تعيين الخلفية الجديدة.");
                bgUploadInput.value = '';
            } catch (error) {
                console.error("BG compression failed:", error);
                showToast("فشل رفع الخلفية.");
            } finally {
                showLoading(false);
            }
        });




        page.querySelector('#darkModeToggle').addEventListener('change', (e) => updateSettings({ darkMode: e.target.checked }));
        page.querySelector('#sentBubbleColor').addEventListener('change', (e) => updateSettings({ sentBubbleBg: e.target.value }));
        page.querySelector('#recvBubbleColor').addEventListener('change', (e) => updateSettings({ recvBubbleBg: e.target.value }));




        // شريط حجم الخط
        const fontSizeRange = page.querySelector('#fontSizeRange');
        const fontSizeValue = page.querySelector('#fontSizeValue');
        
        // 1. تحديث النص فقط أثناء السحب (input)
        fontSizeRange.addEventListener('input', (e) => { 
            const newSize = e.target.value;
            fontSizeValue.textContent = `${newSize}px`; 
        });
        // 2. ربط زر الحفظ
        page.querySelector('#saveFontSize').addEventListener('click', () => {
            const newSize = parseInt(fontSizeRange.value); 
            updateSettings({ fontSize: newSize }); 
            showToast('تم حفظ حجم الخط.');
        });




        // شريط حجم بطاقة الرسالة
        const bubblePaddingRange = page.querySelector('#bubblePaddingRange');
        const bubblePaddingValue = page.querySelector('#bubblePaddingValue');
        
        // 1. تحديث النص فقط أثناء السحب (input)
        bubblePaddingRange.addEventListener('input', (e) => { 
            const val = e.target.value;
            const text = val == 1 ? 'صغير' : (val == 2 ? 'وسط' : 'كبير');
            bubblePaddingValue.textContent = text; 
        });
        // 2. ربط زر الحفظ
        page.querySelector('#saveBubblePadding').addEventListener('click', () => {
            const newPadding = parseInt(bubblePaddingRange.value);
            updateSettings({ bubblePadding: newPadding }); 
            showToast('تم حفظ حجم البطاقة.');
        });




        // ربط أزرار الخلفيات الجاهزة
        const settings = { ...defaultSettings, ...(currentUserProfile.settings) };
        page.querySelectorAll('.background-option').forEach(el => {
            if(settings.chatBackground === el.dataset.url) el.classList.add('selected');
            el.addEventListener('click', () => {
                 page.querySelectorAll('.background-option').forEach(opt => opt.classList.remove('selected'));
                 el.classList.add('selected');
                 updateSettings({ chatBackground: el.dataset.url })
                 showToast("تم تطبيق الخلفية.");
            });
        });




        // زر مسح الخلفية
        page.querySelector('#resetBgBtn').addEventListener('click', () => { 
            page.querySelectorAll('.background-option').forEach(opt => opt.classList.remove('selected')); 
            updateSettings({ chatBackground: '' }); 
            showToast("تم مسح الخلفية.");
        });




        /* --- إصلاح 2: (وسام الإدارة) --- */
        page.querySelector('#badgeSaveBtn').addEventListener('click', async () => {
            const pass = page.querySelector('#badgePass').value;
            let newBadge = null;
            let isValidPass = false;


            if (pass === '1532') {
                newBadge = 'owner'; 
                isValidPass = true;
            } else if (pass === '2026') {
                newBadge = 'moderator'; 
                isValidPass = true;
            } else if (pass === '') {
                newBadge = null; 
                isValidPass = true;
            }
            
            if (!isValidPass) {
                showToast('كلمة المرور غير صحيحة.');
                page.querySelector('#badgePass').value = '';
                return;
            }


            try { 
                await updateDoc(doc(usersCollection, currentUserProfile.id), { badge: newBadge }); 
                showToast(newBadge ? 'تم منح الوسام بنجاح!' : 'تم إزالة الوسام.');
                
                // تحديث الحالة المحلية فوراً
                currentUserProfile.badge = newBadge; 
                
                // إعادة رسم صفحة الإعدادات لإظهار/إخفاء أدوات المالك
                // سيتم مسح كلمة المرور تلقائياً عند إعادة الرسم
                renderSettingsPage(true); 


            } catch(error){ showToast('فشل الحفظ!'); }
        });
        /* --- نهاية الإصلاح 2 --- */




        // زر إعادة ضبط الإعدادات الشخصية
        page.querySelector('#resetAllSettings').addEventListener('click', async () => {
             if(await showConfirmModal("إعادة ضبط الإعدادات", "هل أنت متأكد من إعادة ضبط كل إعداداتك الشخصية؟")){
                try { 
                    await updateSettings(defaultSettings); 
                    showToast('تمت إعادة ضبط إعداداتك الشخصية!'); 
                    renderSettingsPage(true); 
                } catch(error) { showToast('فشل إعادة الضبط!'); }
             }
        });
    }








    /* --- دالة إرسال الرسالة --- */
    async function sendMessage(event) {
        event.preventDefault();




        if (currentUserProfile.isMuted) {
            showToast("لا يمكنك الإرسال، لقد تم تقييد حسابك.");
            return;
        }




        const msgInput = document.getElementById('msgInput');
        const text = msgInput.value.trim();
        if (text && currentUserProfile) {
            const originalText = text;
            msgInput.value = ''; 
            msgInput.focus();
            try { 
                await addDoc(messagesCollection, { text, senderId: currentUserProfile.id, createdAt: Timestamp.now() }); 
            } catch (error) { 
                console.error("Error sending message:", error);
                msgInput.value = originalText; 
                showToast("فشل إرسال الرسالة.");
            }
        }
    }




    /* --- دالة إنشاء عنصر الرسالة في الشات --- */
    function createMessageElement(msgData) {
        const createdAtDate = (msgData.createdAt?.toDate) ? msgData.createdAt.toDate() : new Date();
        const sender = usersCache[msgData.senderId]; 
        if(!sender) {
            console.warn(`Sender not found in cache: ${msgData.senderId}`);
            return null; 
        }
        const isSent = msgData.senderId === currentUserProfile.id;
        const row = document.createElement('div');
        row.className = `message-row ${isSent ? 'sent' : 'recv'}`;
        row.dataset.msgId = msgData.id;
        const time = createdAtDate.toLocaleTimeString('ar-EG', { hour: 'numeric', minute: '2-digit' });




        let badgeHTML = '';
        if (sender.badge === 'owner') badgeHTML = `👑`;
        else if (sender.badge === 'moderator') badgeHTML = `🛡️`;




        const muteIcon = sender.isMuted ? ' 🔇' : ''; 




        row.innerHTML = `<img src="${sender.avatar}" alt="${sender.name}" class="chat-avatar"><div class="bubble ${isSent ? 'sent' : 'recv'}"><div class="bubble-content">${!isSent ? `<div class="bubble-sender">${badgeHTML} ${sender.name}${muteIcon}</div>` : ''}<span>${msgData.text}</span><div class="timestamp">${time}</div></div></div>`;




        const bubble = row.querySelector('.bubble');
        const canDeleteAsAdmin = currentUserProfile.badge === 'owner' || currentUserProfile.badge === 'moderator';
        const isOwnMessage = msgData.senderId === currentUserProfile.id;




        if (canDeleteAsAdmin || isOwnMessage) {
            bubble.style.cursor = 'pointer';
            bubble.title = 'اضغط لحذف الرسالة';
            bubble.addEventListener('click', (e) => {
                e.stopPropagation(); 
                handleDeleteMessage(msgData.id); 
            });
        }




        return row;
    }




    /* --- دالة تحديث الشريط العلوي (الصورة) --- */
    function updateHeaderUI(profile) {
        if (!profile) return;
        headerEl.querySelector('.avatar').src = profile.avatar;
        headerEl.querySelector('.avatar').alt = profile.name;
    };
  </script>
</body>
</html>


